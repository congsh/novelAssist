# 小说辅助创作工具 - AI功能集成规划

本文档整理了项目设计文档_NA2中的AI功能设计内容，用于后续整合到项目设计文档中。

## 1. AI模块架构概述

基于新的设计需求，AI功能模块重构为以下子模块：

### 1.1 AI基础服务模块
- **AI服务连接管理**：支持多种AI服务提供商（OpenAI、Claude、本地模型等）
- **向量数据库接口**：管理向量存储、索引和检索
- **上下文处理框架**：智能构建和管理上下文信息

### 1.2 内容分析模块
- **文本向量化服务**：将文本转化为向量表示
- **内容特征提取**：识别实体、分析风格、解析结构
- **内容一致性检查**：检查角色和情节的一致性

### 1.3 内容生成模块
- **文本生成服务**：基于多种策略生成内容
- **差异比较引擎**：比较原文与生成内容的差异
- **内容修改与润色**：优化语言表达和内容质量
- **续写服务**：智能延续故事内容

### 1.4 Agent系统模块
- **基础Agent框架**：Agent核心架构和通信机制
- **预设Agent实现**：编辑、风格、角色等专用Agent
- **自定义Agent服务**：允许用户定制Agent行为
- **Agent工作链系统**：编排多个Agent协同工作

### 1.5 创作辅助模块
- **内联编辑建议**：在编辑过程中提供实时建议
- **内容检索增强**：智能关联相关内容
- **创作灵感触发**：提供创意和灵感

## 2. 核心功能详细设计

### 2.1 上下文处理框架

上下文处理框架负责智能构建和管理AI交互所需的上下文信息：

```
上下文构建模块
├── 必要上下文
│   ├── 当前段落及其前后文（固定Token数）
│   ├── 当前场景相关人物信息（动态提取）
│   ├── 用户明确指令
├── 可变上下文（根据Token预算动态调整）
│   ├── 相关章节摘要
│   ├── 次要人物信息
│   ├── 相关世界设定
│   ├── 相似情节参考
└── 元控制信息
    ├── AI行为约束
    ├── 输出格式指令
    └── 评估标准
```

**关键功能**：
- **多源上下文组装**：整合来自不同来源的上下文信息
- **动态上下文优先级**：根据当前任务调整上下文重要性
- **上下文压缩算法**：在保留关键信息的同时减少Token消耗
- **Token预算管理**：根据模型限制智能分配Token
- **上下文缓存策略**：缓存常用上下文，减少重复计算

### 2.2 文本向量化服务

文本向量化服务负责将文本转换为向量表示，支持语义搜索和内容关联：

**分段向量化策略**：
- **自适应分段**：根据语义完整性智能分段
- **多级向量化**：段落级、句子级、实体级向量化
- **增量向量更新**：只更新变更部分，提高效率

**向量存储与管理**：
- 使用Chroma作为专用向量数据库
- 按小说ID和实体类型组织集合
- 支持元数据过滤和混合检索

### 2.3 内容特征提取

内容特征提取功能用于从文本中识别和提取有价值的信息：

**实体识别**：
- 角色识别与关联
- 地点识别与关联
- 事件识别与关联
- 时间线识别

**风格分析**：
- 写作风格特征提取
- 语言模式识别
- 情感基调分析
- 叙事视角识别

**结构分析**：
- 情节结构识别
- 叙事节奏分析
- 冲突点识别
- 转折点标记

### 2.4 内容一致性检查

内容一致性检查系统用于检测和解决小说中的不一致问题：

**角色一致性**：
- 角色行为一致性检查
- 角色对话风格一致性
- 角色关系一致性
- 角色发展合理性

**情节一致性**：
- 情节逻辑检查
- 时间线一致性
- 设定符合度检查
- 伏笔与呼应关联

**问题管理**：
- 问题分级（信息、警告、错误）
- 问题定位与上下文提供
- 修复建议生成
- 一键应用修复

### 2.5 文本生成服务

文本生成服务提供多种内容生成策略：

**内容生成策略**：
- 基于提示的生成
- 基于样例的生成
- 风格引导生成
- 多步骤生成流程

**生成控制**：
- 输出格式控制
- 长度与详细度控制
- 创意度控制
- 特定元素包含控制

### 2.6 差异比较引擎

差异比较引擎用于比较原文与生成内容的差异：

**文本差异比较**：
- 字符级差异识别
- 语义级差异识别
- 结构级差异识别
- 差异可视化展示

**差异应用**：
- 选择性接受机制
- 合并冲突解决
- 批量差异处理
- 差异历史追踪

### 2.7 续写服务

续写服务是一种专门用于自动延续故事内容的智能助手：

**工作模式**：
- **大纲引导式续写**：基于大纲点续写，确保符合规划
- **风格一致式续写**：分析并保持作者风格
- **角色驱动式续写**：基于角色特性续写
- **世界设定式续写**：尊重已建立的世界规则

**技术实现**：
- **多元素上下文融合**：整合核心内容、引导元素、风格指导等
- **智能分段生成**：采用递进式生成策略
- **延续性保障措施**：确保内容连贯和一致

## 3. Agent系统设计

### 3.1 基础Agent框架

Agent框架是整个Agent系统的基础架构：

**Agent核心架构**：
- 基础Agent抽象类
- 输入/输出处理接口
- 状态管理机制
- 能力注册系统

**Agent通信机制**：
- 标准化消息格式
- 事件驱动通信
- 同步/异步交互支持
- 错误处理与恢复

### 3.2 预设Agent实现

系统将提供多种预设Agent，每种专注于特定功能：

**功能型Agent**：
- **编辑Agent**：审阅全文，提供全局改进建议
- **风格Agent**：保持全文风格一致性
- **角色Agent**：确保角色言行一致性
- **续写Agent**：根据现有内容和规划续写
- **读者Agent**：模拟读者反应和体验

**Agent能力配置**：
- 预设能力组合
- 默认行为规则
- 标准提示模板
- 优化参数设置

### 3.3 自定义Agent服务

自定义Agent系统允许用户根据特定创作需求定制专属AI辅助角色：

**Agent配置系统**：
- 配置模板管理
- 能力选择器
- 行为规则编辑器
- 资源分配控制

**Agent验证与测试**：
- 配置有效性验证
- 能力兼容性检查
- 性能基准测试
- 行为一致性测试

### 3.4 Agent工作链系统

Agent工作链系统允许多个专业化Agent协同工作，形成自动化创作流水线：

**工作链定义**：
- 节点与连接定义
- 数据流配置
- 条件分支规则
- 循环与迭代控制

**工作链执行**：
- 执行计划生成
- 节点调度与执行
- 状态监控与可视化
- 中断与恢复机制

**预设工作链模板**：
- 短篇创作链
- 角色发展链
- 场景优化链
- 剧情诊断链
- 风格转换链

## 4. 创作辅助功能

### 4.1 内联编辑建议

在编辑过程中提供实时的写作建议：

**实时建议生成**：
- 编辑过程监听
- 上下文感知分析
- 智能建议触发
- 建议优先级排序

**建议展示与交互**：
- 内联提示UI
- 快捷接受/拒绝
- 建议扩展/定制
- 建议历史记录

### 4.2 内容检索增强

智能关联和检索相关内容：

**智能关联检索**：
- 编辑上下文关联
- 相关内容推荐
- 设定元素关联
- 参考资料匹配

**检索结果整合**：
- 多源信息整合
- 相关度排序
- 信息摘要生成
- 上下文嵌入展示

### 4.3 创作灵感触发

提供创意和灵感支持：

**灵感生成机制**：
- 创意提示生成
- 问题引导思考
- 随机灵感触发
- 关联扩展建议

**灵感工具**：
- 头脑风暴助手
- "what if"场景生成
- 角色互动模拟
- 情节分支探索

## 5. AI编辑器界面设计

AI编辑器界面设计注重用户体验和功能可访问性：

```
┌─────────────────────────────────────────────────────────┐
│ 编辑器菜单栏                                             │
├────────────┬────────────────────────┬──────────────────┤
│            │                        │  AI模式选择器     │
│            │                        │  ┌────────────┐  │
│ 导航栏      │       编辑区           │  │角色对话模式 ▼│  │
│            │                        │  └────────────┘  │
│            │                        │                  │
│            │                        │  上下文面板      │
│            │                        │  [人物][地点][大纲]│
│            │                        │                  │
│            │                        │  AI建议历史      │
│            │                        │                  │
├────────────┴────────────────────────┼──────────────────┤
│                                     │                  │
│ AI建议差异视图                       │  指令输入区      │
│ ┌─────────────────────────────────┐ │  ┌────────────┐  │
│ │原文: 他快步走向门口...           │ │  │要求AI...    │  │
│ │AI: -他- +他急切地+ 走向门口...   │ │  └────────────┘  │
│ │    [接受][拒绝][编辑后接受]      │ │  [生成][取消]    │
│ └─────────────────────────────────┘ │                  │
└─────────────────────────────────────┴──────────────────┘
```

### 5.1 AI模式与功能对应

| AI模式 | 主要功能 | 使用场景 |
|--------|----------|---------|
| 润色模式 | 文本优化、错误修正、表达改进 | 初稿修改 |
| 扩展模式 | 场景扩写、细节补充 | 需要更丰富描写 |
| 对话模式 | 生成角色对话、优化对话 | 编写对话场景 |
| 情节模式 | 情节发展建议、转折点创建 | 剧情卡壳 |
| 续写模式 | 基于当前内容续写 | 需要灵感时 |
| 批评模式 | 分析优缺点、提出改进建议 | 需要评估内容 |
| 修改模式 | 按指定需求修改内容 | 目标明确的改动 |

## 6. 数据库设计

为支持新的AI功能，需要添加以下数据表：

### 6.1 Agent相关表

**agent_configs表**：存储Agent配置
- id, name, description, agent_type
- capabilities, behavior_settings, prompt_templates
- resource_settings, user_feedback
- is_active, is_system, metadata

**agent_sessions表**：记录Agent会话
- id, agent_config_id, novel_id, title, status
- context, history, results
- user_feedback, metrics, metadata

### 6.2 工作流相关表

**workflow_templates表**：存储工作流模板
- id, name, description, workflow_definition
- category, tags, usage_count, rating
- is_system, metadata

**workflow_instances表**：记录工作流实例
- id, template_id, novel_id, name, status
- workflow_data, current_node, execution_history
- results, user_feedback, error_message, metadata

### 6.3 上下文相关表

**context_templates表**：存储上下文模板
- id, name, description, template_structure
- category, default_priority, is_system, metadata

**vector_collections表**：记录向量集合元数据
- id, novel_id, collection_name, description
- entity_type, vector_count, embedding_model
- status, last_indexed_at, error_message, metadata

**consistency_issues表**：记录一致性问题
- id, novel_id, chapter_id, issue_type, issue_level
- description, context, start_offset, end_offset
- related_entities, suggestion, status
- resolved_at, resolution_note, metadata

## 7. 实现路径与优先级

### 7.1 第一阶段：基础功能增强（1-2个月）

1. **完善向量化系统**
   - 实现人物、地点、大纲和时间线的向量化
   - 优化向量检索接口和性能

2. **增强内容生成功能**
   - 改进差异比较引擎
   - 升级续写服务
   - 增强内容修改与润色能力

3. **实现基础一致性检查**
   - 开发角色一致性检查功能
   - 实现基本的情节逻辑检查

### 7.2 第二阶段：Agent基础架构（2-3个月）

1. **开发Agent核心架构**
   - 实现基础Agent抽象类
   - 创建Agent通信机制
   - 开发状态管理系统

2. **实现基础编辑Agent和风格Agent**
   - 开发编辑Agent核心功能
   - 实现风格分析和保持功能

3. **创建Agent配置系统**
   - 开发配置界面
   - 实现配置存储和加载

### 7.3 第三阶段：高级功能与集成（3-4个月）

1. **完成Agent系统**
   - 实现剩余预设Agent
   - 开发Agent工作链系统
   - 创建工作流可视化编辑器

2. **增强上下文处理框架**
   - 实现智能上下文筛选
   - 开发上下文压缩算法
   - 完善Token预算管理

3. **集成创作辅助功能**
   - 开发内联编辑建议
   - 实现智能关联检索
   - 创建灵感触发工具

## 8. 技术挑战与解决方案

### 8.1 Agent工作链的可靠执行与状态管理

**挑战**：确保复杂工作链可靠执行，并在失败时恢复

**解决方案**：
- 基于有向无环图的工作流引擎
- 分布式状态存储与同步
- 检查点机制与故障恢复
- 事务性执行与回滚支持

### 8.2 自定义Agent的灵活性与安全性平衡

**挑战**：提供足够的灵活性同时确保系统安全

**解决方案**：
- 沙箱执行环境
- 能力访问控制系统
- 资源使用配额与监控
- 行为异常检测机制

### 8.3 实时AI建议性能与用户体验

**挑战**：实时AI建议可能导致性能问题和用户体验下降

**解决方案**：
- 增量触发与防抖策略
- 轻量级本地模型预筛选
- 后台异步处理与缓存预生成
- 分优先级队列处理请求

## 9. 与现有系统集成

### 9.1 代码结构调整

现有的AI模块需要进行以下调整：

```
src/modules/ai/
├── services/
│   ├── base/                     # 基础服务接口
│   ├── providers/                # AI提供商实现
│   ├── vector/                   # 向量服务
│   ├── analysis/                 # 内容分析服务
│   ├── generation/               # 内容生成服务
│   └── agent/                    # Agent系统服务
├── components/                   # UI组件
├── hooks/                        # React钩子
├── store/                        # 状态管理
└── types/                        # 类型定义
```

### 9.2 接口扩展

需要扩展以下接口：

1. **AIBaseService接口**：添加内容分析和Agent相关方法
2. **向量服务接口**：扩展支持更多实体类型和复杂查询
3. **编辑器服务接口**：集成Agent和内联建议功能

### 9.3 数据迁移

需要进行以下数据迁移：

1. **向量数据迁移**：从LevelDB迁移到Chroma
2. **AI设置扩展**：添加Agent和工作流配置
3. **提示词升级**：升级现有提示词以支持新功能

## 10. 用户体验考虑

### 10.1 功能渐进式引入

为避免用户被复杂功能淹没，采用渐进式引入策略：

1. **基础模式**：仅显示核心AI功能（润色、续写等）
2. **高级模式**：开放Agent和工作流功能
3. **专家模式**：允许自定义Agent和工作流

### 10.2 界面简化

即使在高级功能丰富的情况下，保持界面简洁：

1. **上下文感知界面**：根据当前任务显示相关功能
2. **分层菜单**：将高级功能放在子菜单中
3. **渐进式披露**：先显示简单选项，然后提供"高级设置"

### 10.3 性能优化

确保AI功能不会影响基本编辑体验：

1. **后台处理**：AI处理在后台线程进行
2. **延迟加载**：按需加载AI功能
3. **本地优先**：尽可能使用本地处理，减少网络延迟 